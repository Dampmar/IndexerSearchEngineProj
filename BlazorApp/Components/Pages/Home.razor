@page "/"
@rendermode InteractiveServer

@using System.Text
@using Classes

<PageTitle>Search Documents</PageTitle>

<h1>Search Documents</h1>

<div>
    <input @bind="query" placeholder="Enter your search query" />
    <button class="btn btn-primary" @onclick="Search">Search</button>
</div>

@if (results != null && results.Any())
{
    <h2>Search Results:</h2>
    <ul>
        @foreach (var result in results)
        {
            <li>
                <a href="#" @onclick="() => OpenDocument(result)">@result</a>
            </li>
        }
    </ul>
}
else if (results != null)
{
    <p>No results found.</p>
}

@if (!string.IsNullOrEmpty(selectedDocumentContent))
{
    <h2>Document Content:</h2>
    <div>
        @selectedDocumentContent
    </div>
}

@code {
    private string query;
    private List<string> results;
    private Indexer indexer;
    private string selectedDocumentContent;

    protected override async Task OnInitializedAsync()
    {
        indexer = new Indexer();
        string folderPath = "/Users/jennifervicentesvalle/Desktop/TTU/Object-Oriented Programming/IndexerSearchEngineProj/Folders"; // Replace with actual path
        await Task.Run(() => indexer.IndexFolder(folderPath, "tfidf", "cosine"));
        LoadIndex();
    }

    private void LoadIndex()
    {
        string indexPath = "/Users/jennifervicentesvalle/Desktop/TTU/Object-Oriented Programming/IndexerSearchEngineProj/Folders/index.json"; // Replace with actual path
        indexer.LoadIndex(indexPath);
        Console.WriteLine($"Loaded {indexer.Documents.Count} documents from index.");
    }

    private async Task Search()
    {
        Console.WriteLine($"Query received: {query}");
        if (!string.IsNullOrWhiteSpace(query))
        {
            Console.WriteLine($"Searching for: {query}");
            try
            {
                results = indexer.Search(query, 10, "cosine");
                Console.WriteLine($"Found {results.Count} results.");

                foreach (var result in results)
                {
                    Console.WriteLine($"Result: {result}");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error during search: {ex.Message}");
            }
        }
    }

    private void OpenDocument(string documentName)
    {
        try
        {
            string documentPath = $"/Users/jennifervicentesvalle/Desktop/TTU/Object-Oriented Programming/IndexerSearchEngineProj/Folders/IndexerTesting/{documentName}";
            Console.WriteLine($"Attempting to open document at path: {documentPath}");

            if (!System.IO.File.Exists(documentPath))
            {
                throw new FileNotFoundException($"File not found: {documentPath}");
            }

            string extension = System.IO.Path.GetExtension(documentPath).ToLower();

            if (extension == ".pdf")
            {
                selectedDocumentContent = ReadPdfContent(documentPath);
            }
            else
            {
                selectedDocumentContent = System.IO.File.ReadAllText(documentPath);
            }

            Console.WriteLine($"Opened document: {documentName}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening document: {ex.Message}");
            Console.WriteLine($"Exception details: {ex}");
            selectedDocumentContent = "Error loading document content.";
        }
    }

    private string ReadPdfContent(string filePath)
    {
        StringBuilder text = new StringBuilder();

        using (PdfReader reader = new PdfReader(filePath))
        {
            for (int i = 1; i <= reader.NumberOfPages; i++)
            {
                string pageText = PdfTextExtractor.GetTextFromPage(reader, i);
                text.Append(pageText);
            }
        }

        return text.ToString();
    }
}
